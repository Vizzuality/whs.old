<div class="content_box" id="feature">
  <div class="top"></div>
  <div class="middle">
    <div id="feature_image">

      <div id="feature_title">
        <p id="country"><span><img class="flag" src="/images/flags/<%=@feature.iso_code%>.png"/><%= @feature.country %></span></p>
        <h1><span><%= @feature.title %></span></h1>
        <p class="distance"><span id="<%= @itinerary_type %>">Just <%= distance_of_time_in_words_to_now(@itinerary_time) %> away from <%= @user_city %> by <%= @itinerary_type %></span></p>
      </div>

      <% if @feature.gallery && @feature.gallery.gallery_entries.any? %>
        <div id="slider">
          <% @feature.gallery.gallery_entries.each_with_index do |gallery_entry,i| %>
            <%= image_tag gallery_entry.image.thumbnail(:large).url, :alt => @feature.title, :id =>i %>
          <% end %>
        </div>
      <% else %>
        <img id="default_image" src="/images/default_big.png"/>
      <% end %>
      <div id="photo_credits"></div>

      <div id="big_map_container">
        <div id="big_map"></div>
        <div id="zoomControl">
          <a id="zoomin" href="#"></a>
          <a id="zoomout" href="#"></a>
        </div>
      </div>

    <% if @feature.endangered_year %>
      <div id="endangered"></div>
    <% end %>
    </div>

      <div class="content">
        <div id="main_area">
          <%= simple_format truncate(@feature.description, :length => 2000) %>
          <div id="wikipedia">You can find more information at <a href="<%=@feature.wikipedia_link%>">Wikipedia</a>.</div>
        </div>
        <div id="data_column">
          <div class="map_container">
            <div id="map">
              <img src="http://maps.google.com/maps/api/staticmap?center=<%= @feature.the_geom.y %>,<%= @feature.the_geom.x %>&zoom=8&size=235x162&maptype=terrain&markers=icon:/images/explore/marker_natural.png|<%= @feature.the_geom.y %>,<%= @feature.the_geom.x %>&sensor=false"/>

            </div>
            <div id="img_thumb">
              <% if @feature.gallery && @feature.gallery.gallery_entries.any? %>
                <%= image_tag @feature.gallery.gallery_entries.first.image.thumbnail(:tiny).url, :alt => @feature.title %>
                <% else %>
                <img src="/images/test/test_small.jpg">
              <% end %>

            </div>
            <div id="darken">
              <a href="#"><img src="/images/darken.png"/></a>
              <a href="#" id="show_link">Show map</a>
            </div>
          </div>
          <p class="label" id="first">Date of inscription</p>
          <p class="value"><%= @feature.date_of_inscription %></p>

          <% unless @feature.criteria.blank? %>
          <span class="line"></span>
          <p class="label">Why it is a World Heritage Site</p>
          <% @feature.criteria.split(",").each do |criteria|%>
          <ul>
            <li><%= I18n.t("feature.criteria.#{criteria.delete('[]')}") %></li>
          </ul>
          <% end %>
          <% end %>

          <% unless @feature.size.blank? %>
          <span class="line"></span>
          <p class="label">Size</p>

          <% %>
          <p class="value"><%= number_with_delimiter(number_with_precision(@feature.size.to_f, :precision => 2)) %> Ha</p>
          <% end %>

          <span class="line"></span>
          <p class="label">External links</p>
          <ul>
            <li><a href="<%=@feature.whs_source_page%>">Official Unesco WHS Site</a></li>
            <% if @feature.external_links.present? %>
              <% @feature.external_links.split('#').each do |link| %>
                <li><%= external link %></li>
              <% end %>
            <% end %>
          </ul>
        </div>

        <div id="clear"></div>
      </div>
  </div>
  <div class="bottom"></div>
</div>


<div class="content_box" id="feature_mosaic">
  <div class="top"></div>
  <div class="middle">
    <div class="content">

    <div id="mosaic">
      <ul id="image_list">
        <% @nearest_places.each do |feature|%>
        <li class="mosaic_element<%= cycle('',' middle','', :name => 'mosaic') %>">
          <a href="/features/<%=feature.id%>">
          <div class="mosaic_element_div">

            <% if feature.gallery && feature.gallery.gallery_entries.any? %>
              <%= image_tag feature.gallery.gallery_entries.first.image.thumbnail(:small).url, :alt => feature.title %>
            <% else %>
              <img src="/images/default_mosaic.png">
            <% end %>

            <div class="mosaic_label">
              <p class="place"><%=truncate(feature.title,:length=>60,:delimiter=>"...")%></p>
              <p class="distance"><%= itinerary_time_and_type(feature.distance_in_time, @user_city) %></p>
            </div>
          </div>
          </a>
        </li>
        <%= raw cycle('<li class="separator"></li>','<li class="separator"></li>','', :name => 'separator') %>
        <% end %>
      </ul>
  </div>

      <h3>Near to this site</h3>
    </div>
  </div>
  <div class="bottom"></div>
</div>

<div class="content_box" id="teleport">
  <div class="top"></div>
  <div class="middle">
    <div class="content">
      <div id="message">Or would you rather be randomly teleported to a new beautiful site?</div>
      <%= link_to '"Bean me up, Scotty!"', feature_path(@random_feature), :class => "teleport_#{feature_type}"  , :id => 'green'%>
    </div>
  </div>
  <div class="bottom"></div>
</div>

<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>

<script type="text/javascript">

  var imageInfo;
  <% if @feature.gallery && @feature.gallery.gallery_entries.any? %>
    imageInfo = new Array();
    <% @feature.gallery.gallery_entries.each_with_index do |gallery_entry,i| %>
      imageInfo[<%=i%>] = {
        'author': "<%= gallery_entry.image.author %>",
        'author_url': "<%= gallery_entry.image.author_url %>"
      }
    <% end %>
  <% end %>

  function updateCredits() {
    // Update the photo credits
    var selectedImageIndex = $("div.nivo-controlNav a.active").attr("rel");
    var link = $('<a/>', {href: imageInfo[selectedImageIndex]['author_url']}).text(imageInfo[selectedImageIndex]['author']);
    $("#photo_credits").html('').append("Photo by ").append(link);
    // In slider mode, show the photo credits
    if (!$("div#img_thumb").is(":visible")) {
        $('#photo_credits').fadeIn("fast");
    }
  }

  $(window).load(function() {
    $('#slider').nivoSlider({
      effect: "fade",
      directionNav: false,
      controlNav: true,
      beforeChange: function() {$('#photo_credits').fadeOut("fast")},
      afterChange: updateCredits,
      afterLoad: updateCredits
    });
  });

  $(document).ready( function(){

    $("a#zoomin").click(function(ev) {
        ev.stopPropagation();
        ev.preventDefault();
        map.setZoom(map.getZoom()+1);
    });

    $("a#zoomout").click(function(ev) {
        ev.stopPropagation();
        ev.preventDefault();
        map.setZoom(map.getZoom()-1);
    });


    $("div.map_container").mouseover(function() {
      $("div#darken").show();
      $("a#show_link").show();
    });

    $("div.map_container").mouseout(function() {
      $("div#darken").hide();
      $("a#show_link").hide();
    });

    $("div.map_container div#darken a").click(function(ev) {
      ev.stopPropagation();
      ev.preventDefault();

      if ($("div#img_thumb").is(":visible")) {
        // Swap big area to images
          $("#slider").fadeIn();
          $("#photo_credits").fadeIn();
          $("div#img_thumb").hide();
          $("a#show_link").html("Show map");
      } else {
        // Swap big area to map
          $("div#big_map_container").css("visibility","visible");
          $("#slider").fadeOut();
          $("#photo_credits").fadeOut();
          $("div#img_thumb").show();
          $("a#show_link").html("Show images");
      }
    });

    // Map customization

    var myOptions = {
      zoom: 8,
      disableDefaultUI: true,
      center: new google.maps.LatLng(<%= @feature.the_geom.y %>,<%= @feature.the_geom.x %>),
      mapTypeId: google.maps.MapTypeId.TERRAIN
    };
    var map = new google.maps.Map(document.getElementById("big_map"), myOptions);

    <% @nearest_places.each_with_index do |near_feature, i|%>

    var latlng_<%=i%> = new google.maps.LatLng(<%= near_feature.lat %>, <%= near_feature.lon %>);
    var marker_<%=i%> = new google.maps.Marker({
      position: latlng_<%=i%>,
      map: map,
      title:"<%=near_feature.title%>",
      icon: "/images/marker_<%=@feature.type%>_mini.png"
    });
    google.maps.event.addListener(marker_<%=i%>, "click", function() {window.location = "/features/<%=near_feature.id%>"});
    <% end %>

  // Adding the marker
    latlng = new google.maps.LatLng(<%= @feature.the_geom.y %>, <%= @feature.the_geom.x %>);
    marker = new google.maps.Marker({
      position: latlng,
      map: map,
      title:"<%=@feature.title%>",
      icon: "/images/explore/marker_<%=@feature.type%>.png"
    });


  });

</script>

